<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." name="download-convert-upload">
	<!--<property name="baseurl" value="http://colin.maudry.com/share/"/>-->
	<property name="baseurl" value="http://data.gouv.fr/fr/"/>
	<tstamp>
		<format property="now"
			pattern="yyyy-MM-dd'T'hh-mm-ss"/>
	</tstamp>
  <target name="download">
  	<echo>[DOWNLOAD]</echo>
  	<mkdir dir="csv/history"/>
  	<echo>Downloading datasets.csv...</echo>
  	<get
  		verbose="false"
  		src="${baseurl}datasets.csv"
  		dest="csv/datasets.csv"/>
  	<echo>Downloading resources.csv...</echo>
  	<get
  		verbose="false"
  		src="${baseurl}resources.csv"
  		dest="csv/resources.csv"/>
  </target>
	
	<target name="clean" depends="download">
		<echo>[CLEAN]</echo>
		<mkdir dir="csv/temp/"/>
		<echo>Removing empty lines that mess with TARQL querying...</echo>
		<copy todir="csv/temp/">
			<fileset dir="csv/" includes="*.csv"/>
			<filterchain>
				<ignoreblank/>	
			</filterchain>
		</copy>
		<move todir="csv/">
			<fileset dir="csv/temp/" includes="*.csv"/>
		</move>
		<echo> </echo>
		<echo>Unescaping escaped quotes that are followed by a semicolon (\";)... </echo>
		<replaceregexp flags="gs" file="csv/datasets.csv" encoding="utf-8" match='\\";' replace='";'/>
		<echo> </echo>
		<echo>Replacing "." with "_" in headers to ease TARQL processing...</echo>
		<replace file="csv/datasets.csv" encoding="utf-8" token=';"metric.' value=';"metric_'/>
		<replace file="csv/resources.csv" encoding="utf-8"  token=';"checksum.' value=';"checksum_'/>
		
		<echo>Archiving clean CSVs...</echo>
		<copy tofile="csv/history/${now}_datasets.csv">
			<file basedir="csv/" name="datasets.csv"/>
		</copy>
		<copy tofile="csv/history/${now}_resources.csv">
			<file basedir="csv/" name="resources.csv"/>
		</copy> 	
		
		
		<!--<echo>Replacing "." with "_" in headers to ease TARQL processing...</echo>
		<loadfile srcfile="test.xml" property="file.first.and.last.line.removed">
			<filterchain>
				<filterreader classname="org.apache.tools.ant.filters.HeadFilter">
					<param name="lines" value="-1"/>
					<param name="skip" value="1"/>
				</filterreader>
				<filterreader classname="org.apache.tools.ant.filters.TailFilter">
					<param name="lines" value="-1"/>
					<param name="skip" value="1"/>
				</filterreader>
			</filterchain>
		</loadfile>-->
	</target>
	
	<target name="convert">
		<mkdir dir="rdf"/>
		<exec dir="." command="tarql" searchpath="true" output="rdf/${now}_datasets.ttl">
						
		
		</exec>
	</target>
</project>